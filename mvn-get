#!/bin/bash

set -euo pipefail

timestamp()
{
	/usr/bin/date -Ins -u
}

say()
{
	echo -e "$(timestamp): ${@}"
}

fail()
{
	say "âŒ ${@}" 1>&2
	exit ${EXIT_CODE:-1}
}

download()
{
	local URL="${1}"
	local AUTH="${2:-""}"
	local DEST="${3:-""}"
	[ -n "${AUTH}" ] && AUTH="--user '${AUTH}'"
	[ -n "${DEST}" ] && DEST=(--output "${DEST}")
	"${CURL}" --location --fail --disallow-username-in-url --config <(echo -n "${AUTH}") "${DEST[@]}" "${URL}"
}

get_repo_auth()
{
	local URL="${1}"
	# TODO: How to fetch this?
}

usage()
{
	{
		echo -e "usage: ${BASH_SOURCE:-${0}} spec1 [spec2 spec3 ... specN]"
		echo -e ""
		echo -e "\tArtifact specs are of the form artifact[@repo]=target"
		echo -e ""
		echo -e "\t\tartifact: groupId:artifactId:version[:packaging[:classifier]]"
		echo -e "\t\trepo:     URL to the Maven repository housing the artifact (optional)"
		echo -e "\t\ttarget:   The final path where the file will be copied into"
		echo -e ""
	} 1>&2
	exit 1
}

[ ${#} -ge 1 ] || usage

XMLSTARLET="$(type -P xmlstarlet)" || fail "xmlstarlet is not installed - cannot proceed"
CURL="$(type -P curl)" || fail "curl is not installed - cannot proceed"

# Each parameter is of the form artifact[@repo]=target
for n in "${@}" ; do
	# TODO: Split the repo from the artifact

	[[ "${n}" =~ ^([^@=[:space:]]+)(@([^=[:space:]]*))?=(.+)$ ]] || fail "Artifact spec [${n}] is not valid"
	ARTIFACT="${BASH_REMATCH[1]}"
	REPO_URL="${BASH_REMATCH[3]}"
	DEST="${BASH_REMATCH[4]}"

	[[ "${ARTIFACT}" =~ ^([^:[:space:]]+):([^:[:space:]]+):([^:[:space:]]+)(:([^:[:space:]]+)(:([^:[:space:]]+))?)?$ ]] || fail "The artifact string [${ARTIFACT}] is not valid"
	GROUP_ID="${BASH_REMATCH[1]}"
	ARTIFACT_ID="${BASH_REMATCH[2]}"
	VERSION="${BASH_REMATCH[3]}"
	EXTENSION="${BASH_REMATCH[5]}"
	CLASSIFIER="${BASH_REMATCH[7]}"

	AUTH="$(get_repo_auth "${REPO_URL}")"

	GROUP_PATH="${GROUP_ID//./\/}"
	BASE="${REPO_URL}/${GROUP_PATH}/${ARTIFACT_ID}/${VERSION}"

	say "ðŸ‘‰ Downloading:"
	say "\tArtifact:   [${ARTIFACT}]"
	say "\tRepository: [${REPO_URL}]"
	say "\tFile:       [${DEST}]"

	FINAL_VERSION="${VERSION}"
	if [[ "${VERSION}" =~ -SNAPSHOT$ ]] ; then
		say "âš ï¸ This version is a snapshot - identifying the final artifact to download"
		POM="$(download "${BASE}/maven-metadata.xml" "${AUTH}" 2>/dev/null)" || fail "Failed to download the artifact metadata for ${GROUP_ID}:${ARTIFACT_ID}:${VERSION}"
		TIMESTAMP="$("${XMLSTARLET}" sel -t -v '/metadata/versioning/snapshot/timestamp' <<< "${POM}")"
		BUILD_NUMBER="$("${XMLSTARLET}" sel -t -v '/metadata/versioning/snapshot/buildNumber' <<< "${POM}")"
		FINAL_VERSION="$(echo -n "${VERSION}" | sed -e "s/-SNAPSHOT$/-${TIMESTAMP}-${BUILD_NUMBER}/g")"
		say "âœ… The latest snapshot version is ${FINAL_VERSION}"
	fi

	BASE="${BASE}/${ARTIFACT_ID}-${FINAL_VERSION}"
	if [ -z "${EXTENSION}" ] ; then
		say "âš ï¸ Packaging (type) not provided, must identify it from the POM"
		POM="$(download "${BASE}.pom" "${AUTH}" 2>/dev/null)" || fail "Failed to download the artifact POM for ${GROUP_ID}:${ARTIFACT_ID}:${VERSION}"
		EXTENSION="$("${XMLSTARLET}" sel -N "p=http://maven.apache.org/POM/4.0.0" -t -v '/p:project/p:packaging' <<< "${POM}")"
		[ -z "${EXTENSION}" ] && EXTENSION="jar"
		say "âœ… Will download the ${EXTENSION} artifact"
	fi

	# Must be given explicitly ...
	[ -n "${CLASSIFIER}" ] && CLASSIFIER="-${CLASSIFIER}"

	download "${BASE}${CLASSIFIER}.${EXTENSION}" "${AUTH}" "${DEST}"
done
